name: Build Wails App

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            asset_name: linux.AppImage
          - os: macos-latest
            platform: darwin
            asset_name: macos.app.zip
          - os: windows-latest
            platform: windows
            asset_name: windows.exe.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # Linux specific setup
      - name: Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      # macOS specific setup
      - name: macOS Dependencies
        if: matrix.platform == 'darwin'
        run: |
          brew install pkg-config gtk+3 webkitgtk

      # Build the application
      - name: Build Application
        env:
          CGO_ENABLED: 1
        run: |
          wails build -platform ${{ matrix.platform }} -clean -o "app-${{ matrix.platform }}"

      # Package artifacts
      - name: Package Linux AppImage
        if: matrix.platform == 'linux'
        run: |
          # Install tools for AppImage
          sudo apt-get install -y wget file
          
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy binary
          cp build/bin/app-linux AppDir/usr/bin/ || cp build/bin/app AppDir/usr/bin/
          chmod +x AppDir/usr/bin/*
          
          # Create AppRun
          cat > AppDir/AppRun << 'EOF'
#!/bin/bash
HERE="$(dirname "$(readlink -f "${0}")")"
cd "$HERE/usr/bin"
exec "./$(ls | head -1)" "$@"
EOF
          chmod +x AppDir/AppRun
          
          # Create desktop file
          cat > AppDir/app.desktop << 'EOF'
[Desktop Entry]
Name=My Wails App
Exec=AppRun
Icon=app
Type=Application
Categories=Utility;
EOF
          
          # Create icon (placeholder if not exists)
          if [ -f build/appicon.png ]; then
            cp build/appicon.png AppDir/app.png
            cp build/appicon.png AppDir/usr/share/icons/hicolor/256x256/apps/app.png
          else
            convert -size 256x256 xc:blue AppDir/app.png
            convert -size 256x256 xc:blue AppDir/usr/share/icons/hicolor/256x256/apps/app.png
          fi
          
          # Build AppImage
          ./appimagetool-x86_64.AppImage AppDir myapp-linux-x86_64.AppImage
          
          # Move to dist folder
          mkdir -p dist
          mv myapp-linux-x86_64.AppImage dist/

      - name: Package macOS App
        if: matrix.platform == 'darwin'
        run: |
          mkdir -p dist
          cd build/bin
          
          # Create zip of the .app bundle
          if [ -d "My Wails App.app" ]; then
            zip -r ../../dist/myapp-macos.zip "My Wails App.app"
          elif [ -d "app.app" ]; then
            zip -r ../../dist/myapp-macos.zip "app.app"
          else
            # If no .app bundle, zip the binary
            zip ../../dist/myapp-macos.zip *
          fi

      - name: Package Windows App
        if: matrix.platform == 'windows'
        run: |
          mkdir -p dist
          cd build/bin
          
          # Find the main executable
          for file in *.exe; do
            if [ -f "$file" ]; then
              main_exe="$file"
              break
            fi
          done
          
          if [ -n "$main_exe" ]; then
            # Create installer directory
            mkdir -p myapp-windows
            cp * myapp-windows/ 2>/dev/null || true
            cd myapp-windows
            
            # Create batch file for easier execution
            echo "@echo off" > Run.bat
            echo "start \"\" \"%~dp0$main_exe\"" >> Run.bat
            
            # Zip everything
            powershell "Compress-Archive -Path * -DestinationPath ..\..\..\dist\myapp-windows.zip"
          else
            # Fallback: zip everything
            powershell "Compress-Archive -Path * -DestinationPath ..\..\dist\myapp-windows.zip"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            dist/*
            build/bin/*
          retention-days: 7

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy and rename artifacts
          for artifact in artifacts/*; do
            platform=$(basename $artifact | sed 's/-build//')
            case $platform in
              linux)
                find $artifact -name "*.AppImage" -exec cp {} release-assets/myapp-linux-x86_64.AppImage \;
                ;;
              darwin)
                find $artifact -name "*.zip" -exec cp {} release-assets/myapp-macos-x64.zip \;
                ;;
              windows)
                find $artifact -name "*.zip" -exec cp {} release-assets/myapp-windows-x64.zip \;
                ;;
            esac
          done
          
          # List files for debugging
          ls -la release-assets/
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: false

  test-build:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build failed!"
            exit 1
          else
            echo "All builds completed successfully!"
          fi
