name: Build and Release

on:
  push:
    branches:
      - main
      - nightly
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
          - platform: linux
            os: ubuntu-22.04
          - platform: macos
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Setup Node (for frontend / Wails)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Build app (Wails)
        run: |
          wails build -platform ${{ matrix.platform }} -clean

      ##################################################
      # LINUX — APPIMAGE + TAR.GZ
      ##################################################
      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex

          # Download appimagetool
          wget -q -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

          # Create AppDir structure
          mkdir -p HyVanila.AppDir/usr/bin
          mkdir -p HyVanila.AppDir/usr/share/applications
          mkdir -p HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps
          mkdir -p HyVanila.AppDir/usr/share/metainfo

          # Copy binary
          cp build/bin/HyVanila HyVanila.AppDir/usr/bin/
          chmod +x HyVanila.AppDir/usr/bin/HyVanila

          # Save webkit40 binary for Flatpak later (optional)
          if [ -f build/bin/HyVanila-webkit40 ]; then
            cp build/bin/HyVanila-webkit40 /tmp/HyVanila-flatpak-binary
          fi

          # Copy icon
          convert build/appicon.png -resize 512x512 HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png || \
            cp build/appicon.png HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png

          cp HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png HyVanila.AppDir/hyvanila.png

          # Desktop file
          cat > HyVanila.AppDir/hyvanila.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyVanila
          Exec=HyVanila
          Icon=hyvanila
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyVanila
          Comment=A modern launcher for Hytale
          DESKTOP

          cp HyVanila.AppDir/hyvanila.desktop HyVanila.AppDir/usr/share/applications/

          # AppStream metadata
          cat > HyVanila.AppDir/usr/share/metainfo/hyvanila.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyvanila.HyVanila</id>
            <name>HyVanila</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyVanila is an open-source, community-driven launcher for Hytale.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA

          # AppRun
          cat > HyVanila.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}

          export PATH="${HERE}/usr/bin:${PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

          # Check WebKit2GTK 4.1
          if ! ldconfig -p 2>/dev/null | grep -q "libwebkit2gtk-4.1.so.0"; then
            echo ""
            echo "HyVanila requires WebKit2GTK 4.1"
            echo ""
            echo "Arch:   sudo pacman -S webkit2gtk-4.1"
            echo "Ubuntu: sudo apt install libwebkit2gtk-4.1-0"
            echo "Fedora: sudo dnf install webkit2gtk4.1"
            echo ""
            exit 1
          fi

          exec "${HERE}/usr/bin/HyVanila" "$@"
          APPRUN

          # Fix permissions
          chmod +x HyVanila.AppDir/AppRun

          # Build AppImage
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyVanila.AppDir HyVanila-x86_64.AppImage

          # Replace build output
          rm -rf build/bin/*
          mv HyVanila-x86_64.AppImage build/bin/

          # Create tar.gz fallback
          cd HyVanila.AppDir/usr/bin
          tar -czvf ../../../HyVanila-linux-x86_64.tar.gz HyVanila
          cd ../../..
          mv HyVanila-linux-x86_64.tar.gz build/bin/

      ##################################################
      # WINDOWS — ZIP
      ##################################################
      - name: Package Windows
        if: matrix.platform == 'windows'
        run: |
          mkdir dist
          powershell Compress-Archive build/bin/* dist/HyVanila-windows-x64.zip

      ##################################################
      # MACOS — ZIP
      ##################################################
      - name: Package macOS
        if: matrix.platform == 'macos'
        run: |
          mkdir dist
          cd build/bin
          zip -r ../../dist/HyVanila-macos.zip .
          cd ../..

      ##################################################
      # RELEASE
      ##################################################
      - name: Upload Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/bin/*
            dist/*
