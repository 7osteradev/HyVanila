name: Build and Release

on:
  push:
    branches:
      - nightly
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-amd64
            platform: linux
          - os: windows-latest
            name: windows-amd64
            platform: windows
          - os: macos-14
            name: darwin-arm64
            platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          # Install both webkit2gtk versions - 4.0 for Flatpak (older distros), 4.1 for AppImage (modern distros)
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev
      
      - name: Build
        shell: bash
        run: |
          # Extract version from tag or use branch name
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            APP_TITLE="HyVanila - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            # For nightly builds, use commit short SHA
            VERSION="nightly-$(git rev-parse --short HEAD)"
            APP_TITLE="HyVanila Nightly - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            # For main branch without tag, get latest version from git tags
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
            VERSION="${LATEST_TAG#v}-dev"
            APP_TITLE="HyVanila Dev - Hytale Launcher"
          else
            VERSION="dev"
            APP_TITLE="HyVanila - Hytale Launcher"
          fi
          
          echo "Building version: $VERSION"
          echo "App title: $APP_TITLE"
          
          # Build with webkit2gtk-4.1 for AppImage (modern systems)
          wails build -clean -tags webkit2_41 -ldflags "-X 'HyVanila/app.AppVersion=$VERSION' -X 'HyVanila/app.AppTitle=$APP_TITLE'"
          
          # On Linux, also build with webkit2gtk-4.0 for Flatpak (older distros like PopOS 22.04)
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            # Save webkit41 binary before building webkit40 (which uses -clean)
            cp build/bin/HyVanila /tmp/HyVanila-webkit41
            echo "Building legacy version with webkit2gtk-4.0 for Flatpak..."
            wails build -clean -ldflags "-X 'HyVanila/app.AppVersion=$VERSION' -X 'HyVanila/app.AppTitle=$APP_TITLE'"
            mv build/bin/HyVanila build/bin/HyVanila-webkit40
            # Restore webkit41 as main binary for AppImage
            mv /tmp/HyVanila-webkit41 build/bin/HyVanila
          fi

          # On Windows, rename binary to HyVanila-Portable.exe
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            mv build/bin/HyVanila.exe build/bin/HyVanila-Portable.exe
          fi
      
      - name: Create DMG (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Sign the app bundle BEFORE creating DMG
          echo "Signing HyVanila.app..."
          # Remove quarantine attributes
          xattr -cr build/bin/HyVanila.app || true
          # Ad-hoc sign the app bundle
          codesign --force --deep --sign - build/bin/HyVanila.app || {
            echo "Warning: Codesign failed, trying without deep flag..."
            codesign --force --sign - build/bin/HyVanila.app || true
          }
          echo "App signed successfully"
          
          # Create a clean directory for DMG contents
          mkdir -p dmg-contents
          
          # Move only the .app bundle to dmg-contents
          mv build/bin/HyVanila.app dmg-contents/
          
          # Create a helper script to remove quarantine from Applications
          cat > dmg-contents/Fix-HyVanila.command << 'HELPER'
          #!/bin/bash
          clear
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       HyVanila - Fix macOS Security Warning           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Check common locations for HyVanila.app
          APP_PATH=""
          if [ -d "/Applications/HyVanila.app" ]; then
              APP_PATH="/Applications/HyVanila.app"
          elif [ -d "$HOME/Applications/HyVanila.app" ]; then
              APP_PATH="$HOME/Applications/HyVanila.app"
          elif [ -d "$(dirname "$0")/HyVanila.app" ]; then
              APP_PATH="$(dirname "$0")/HyVanila.app"
          fi
          
          if [ -z "$APP_PATH" ]; then
              echo "âŒ HyVanila.app not found!"
              echo ""
              echo "Please drag HyVanila.app to your Applications folder first,"
              echo "then run this script again."
              echo ""
              echo "Or run manually in Terminal:"
              echo "  xattr -cr /path/to/HyVanila.app"
              echo ""
              read -p "Press Enter to close..."
              exit 1
          fi
          
          echo "Found HyVanila at: $APP_PATH"
          echo ""
          echo "Removing quarantine attribute..."
          xattr -cr "$APP_PATH"
          
          if [ $? -eq 0 ]; then
              echo ""
              echo "âœ… Success! HyVanila is now ready to use."
              echo ""
              echo "You can now open HyVanila from your Applications folder."
          else
              echo ""
              echo "âŒ Failed to remove quarantine. Try running manually:"
              echo "  sudo xattr -cr \"$APP_PATH\""
          fi
          
          echo ""
          read -p "Press Enter to close..."
          HELPER
          chmod +x dmg-contents/Fix-HyVanila.command
          
          # Create DMG from clean directory
          create-dmg \
            --volname "HyVanila" \
            --window-pos 200 120 \
            --window-size 700 400 \
            --icon-size 100 \
            --icon "HyVanila.app" 175 120 \
            --hide-extension "HyVanila.app" \
            --app-drop-link 525 120 \
            --icon "Fix-HyVanila.command" 350 280 \
            "HyVanila-macOS-arm64.dmg" \
            "dmg-contents"
          
          # Clean build/bin and put only DMG there
          rm -rf build/bin/*
          mv HyVanila-macOS-arm64.dmg build/bin/
      
      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex

          # Download appimagetool
          wget -q -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

          # Create AppDir structure
          mkdir -p HyVanila.AppDir/usr/bin
          mkdir -p HyVanila.AppDir/usr/share/applications
          mkdir -p HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps
          mkdir -p HyVanila.AppDir/usr/share/metainfo

          # Copy binary
          cp build/bin/HyVanila HyVanila.AppDir/usr/bin/
          chmod +x HyVanila.AppDir/usr/bin/HyVanila

          # Save webkit40 binary for Flatpak later
          cp build/bin/HyVanila-webkit40 /tmp/HyVanila-flatpak-binary

          # Copy icon
          convert build/appicon.png -resize 512x512 HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png || \
            cp build/appicon.png HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png

          cp HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png HyVanila.AppDir/hyvanila.png

          # Desktop file
          cat > HyVanila.AppDir/hyvanila.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyVanila
          Exec=HyVanila
          Icon=hyvanila
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyVanila
          Comment=A modern launcher for Hytale
          DESKTOP

          cp HyVanila.AppDir/hyvanila.desktop HyVanila.AppDir/usr/share/applications/

          # AppStream metadata
          cat > HyVanila.AppDir/usr/share/metainfo/hyvanila.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyvanila.HyVanila</id>
            <name>HyVanila</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyVanila is an open-source, community-driven launcher for Hytale.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA

          # AppRun
          cat > HyVanila.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}

          export PATH="${HERE}/usr/bin:${PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

          # Check WebKit2GTK 4.1
          if ! ldconfig -p 2>/dev/null | grep -q "libwebkit2gtk-4.1.so.0"; then
            echo ""
            echo "HyVanila requires WebKit2GTK 4.1"
            echo ""
            echo "Arch:   sudo pacman -S webkit2gtk-4.1"
            echo "Ubuntu: sudo apt install libwebkit2gtk-4.1-0"
            echo "Fedora: sudo dnf install webkit2gtk4.1"
            echo ""
            exit 1
          fi

          exec "${HERE}/usr/bin/HyVanila" "$@"
          APPRUN

          # Fix permissions (IMPORTANT)
          chmod +x HyVanila.AppDir/AppRun

          # Build AppImage
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyVanila.AppDir HyVanila-x86_64.AppImage

          # Replace build output
          rm -rf build/bin/*
          mv HyVanila-x86_64.AppImage build/bin/

          # Create tar.gz fallback
          cd HyVanila.AppDir/usr/bin
          tar -czvf ../../../HyVanila-linux-x86_64.tar.gz HyVanila
          cd ../../..
          mv HyVanila-linux-x86_64.tar.gz build/bin/

 
          # Save the webkit40 binary for Flatpak packaging (for older distros)
          cp build/bin/HyVanila-webkit40 /tmp/HyVanila-flatpak-binary
          
          # Copy icon at 512x512 for high resolution displays
          convert build/appicon.png -resize 512x512 HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png || {
            cp build/appicon.png HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png
          }
          cp HyVanila.AppDir/usr/share/icons/hicolor/512x512/apps/hyvanila.png HyVanila.AppDir/hyvanila.png
          
          # Create desktop file (must be at root of AppDir)
          cat > HyVanila.AppDir/hyvanila.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyVanila
          Exec=HyVanila
          Icon=hyvanila
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyVanila
          Comment=A modern launcher for Hytale
          DESKTOP
          
          # Copy desktop file to standard location too
          cp HyVanila.AppDir/hyvanila.desktop HyVanila.AppDir/usr/share/applications/
          
          # Create AppStream metadata (helps with SteamOS integration)
          cat > HyVanila.AppDir/usr/share/metainfo/hyvanila.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyvanila.HyVanila</id>
            <name>HyVanila</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyVanila is an open-source, community-driven launcher for Hytale that provides mod management, multiple instances, and more.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA
          
          # Create simple AppRun - no complex bundling, just use system WebKit
          cat > HyVanila.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          # Simple AppRun for HyVanila
          
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Export paths
          export PATH="${HERE}/usr/bin:${PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
          
          # Check if WebKit2GTK 4.1 is available on the system
          if ! ldconfig -p 2>/dev/null | grep -q "libwebkit2gtk-4.1.so.0"; then
            
            # Terminal message (always shown)
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  HyVanila requires WebKit2GTK 4.1                            â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  OPTION 1 (Recommended): Use Flatpak                        â•‘"
            echo "â•‘  Download HyVanila.flatpak from the same release.            â•‘"
            echo "â•‘  It bundles all dependencies - no setup required!           â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  OPTION 2: Install WebKit on your system                    â•‘"
            echo "â•‘  â€¢ Arch:   sudo pacman -S webkit2gtk-4.1                    â•‘"
            echo "â•‘  â€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0             â•‘"
            echo "â•‘  â€¢ Fedora: sudo dnf install webkit2gtk4.1                   â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  Note: Most Linux desktops already have WebKit installed    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # GUI dialog with multiple fallbacks
            ERROR_MSG=$'HyVanila requires WebKit2GTK 4.1 to run.\n\nOPTION 1 (Recommended): Use Flatpak\nDownload HyVanila.flatpak from the same release.\nIt bundles all dependencies - no setup required!\n\nOPTION 2: Install WebKit on your system\nâ€¢ Arch:   sudo pacman -S webkit2gtk-4.1\nâ€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0\nâ€¢ Fedora: sudo dnf install webkit2gtk4.1\n\nMost Linux desktops already have WebKit installed.'

            # Try GUI dialogs in order of preference
            if command -v zenity &> /dev/null; then
              zenity --error --title="HyVanila - Missing Dependency" --text="$ERROR_MSG" --width=500 --no-wrap 2>/dev/null || true
            elif command -v kdialog &> /dev/null; then
              kdialog --title "HyVanila - Missing Dependency" --error "$ERROR_MSG" 2>/dev/null || true
            elif command -v xmessage &> /dev/null; then
              xmessage -center -title "HyVanila - Missing Dependency" "$ERROR_MSG" 2>/dev/null || true
            elif command -v notify-send &> /dev/null; then
              notify-send -u critical "HyVanila - Missing Dependency" "WebKit2GTK 4.1 required. Use Flatpak or install webkit2gtk-4.1" 2>/dev/null || true
            fi
            
            # Wait a moment for user to see the message before exiting
            sleep 2
            exit 1
          fi
          
          # Launch HyVanila
          exec "${HERE}/usr/bin/HyVanila" "$@"
          APPRUN
          chmod +x HyPrism.AppDir/AppRun
          
          # Build AppImage with ARCH set
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyVanila.AppDir HyVanila-x86_64.AppImage
          
          # Replace binary with AppImage
          rm -rf build/bin/*
          mv HyVanila-x86_64.AppImage build/bin/
          
          # Also create a tar.gz for systems where AppImage doesn't work
          cd HyVanila.AppDir/usr/bin
          tar -czvf ../../../HyVanila-linux-x86_64.tar.gz HyVanila
          cd ../../..
          mv HyVanila-linux-x86_64.tar.gz build/bin/

      - name: Build Flatpak (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex
          
          echo "=========================================="
          echo "Starting Flatpak build process"
          echo "=========================================="
          
          # Install Flatpak and flatpak-builder
          echo "Installing Flatpak..."
          sudo apt-get update -qq
          sudo apt-get install -y flatpak flatpak-builder
          
          # Add Flathub remote for user
          echo "Adding Flathub remote..."
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          
          # Install required runtime and SDK for freedesktop 22.08
          echo "Installing Freedesktop SDK 22.08..."
          flatpak install --user -y --noninteractive flathub org.freedesktop.Sdk//22.08 org.freedesktop.Platform//22.08 || true
          
          # Verify runtime is installed
          echo "Verifying runtime installation..."
          flatpak list --user | grep org.freedesktop || echo "Runtime checking..."
          
          # Prepare all files in the flatpak directory
          echo "Preparing files..."
          # Use the webkit40 binary for Flatpak (older distro compatibility)
          cp /tmp/HyVanila-flatpak-binary flatpak/HyVanila
          chmod +x flatpak/HyVanila
          
          # Resize icon to 512x512 for Flatpak (max allowed size)
          echo "Resizing icon to 512x512..."
          convert build/appicon.png -resize 512x512 flatpak/dev.hyvanila.HyVanila.png || {
            echo "ImageMagick not found, trying with sips..."
            sips -z 512 512 build/appicon.png --out flatpak/dev.hyvanila.HyVanila.png
          }
          
          # Verify all required files exist
          echo "Verifying files..."
          ls -lh flatpak/HyVanila
          ls -lh flatpak/dev.hyvanila.HyVanila.png
          ls -lh flatpak/dev.hyvanila.HyVanila.desktop
          ls -lh flatpak/dev.hyvanila.HyVanila.metainfo.xml
          ls -lh flatpak/dev.hyvanila.HyVanila.json
          
          # Test that binary is executable
          file flatpak/HyVanila
          
          # Build the Flatpak
          echo "=========================================="
          echo "Building Flatpak bundle..."
          echo "=========================================="
          cd flatpak
          
          flatpak-builder \
            --user \
            --force-clean \
            --repo=repo \
            --install-deps-from=flathub \
            builddir \
            dev.hyvanila.HyVanila.json
          
          echo "Creating Flatpak bundle..."
          flatpak build-bundle repo HyVanila.flatpak dev.hyvanila.HyVanila
          
          # Verify bundle was created and has content
          if [ ! -f HyPrism.flatpak ]; then
            echo "ERROR: Flatpak bundle was not created!"
            exit 1
          fi
          
          BUNDLE_SIZE=$(stat -c%s HyPrism.flatpak 2>/dev/null || stat -f%z HyPrism.flatpak)
          echo "Bundle created successfully: $BUNDLE_SIZE bytes"
          
          if [ "$BUNDLE_SIZE" -lt 1000000 ]; then
            echo "ERROR: Bundle size too small, something went wrong!"
            exit 1
          fi
          
          mv HyVanila.flatpak ../build/bin/
          
          # Verify it was moved
          ls -lh ../build/bin/HyVanila.flatpak
          
          # Clean up
          rm -f HyPrism dev.hyprism.HyPrism.png
          rm -rf repo builddir .flatpak-builder
          
          echo "=========================================="
          echo "Flatpak build completed successfully!"
          echo "=========================================="

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HyVanila-${{ matrix.name }}
          path: build/bin/*
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/nightly'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Flatten artifacts
        run: |
          # Move all files from subdirectories to artifacts root
          find artifacts -type f -mindepth 2 -exec mv {} artifacts/ \;
          # Remove empty subdirectories
          find artifacts -type d -empty -delete
      
      - name: Determine version and release type
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            RELEASE_NAME="v$VERSION"
            TAG_NAME="v$VERSION"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            VERSION="nightly-$(git rev-parse --short HEAD)"
            IS_PRERELEASE="true"
            RELEASE_NAME="Nightly Build $(date +'%Y-%m-%d')"
            TAG_NAME="nightly"
          else
            VERSION="dev"
            IS_PRERELEASE="true"
            RELEASE_NAME="Development Build"
            TAG_NAME="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Create version.json for auto-updater
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          cat > artifacts/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/7osteradev/HyVanila/releases/download/$TAG_NAME/HyVanila-x86_64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/7osteradev/HyVanila/releases/download/$TAG_NAME/HyVanila-linux-x86_64.tar.gz",
                  "sha256": ""
                },
                "flatpak": {
                  "url": "https://github.com/7osteradev/HyVanila/releases/download/$TAG_NAME/HyVanila.flatpak",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/7osteradev/HyVanila/releases/download/$TAG_NAME/HyVanila-Portable.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "amd64": {
                "launcher": {
                  "url": "",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/7osteradev/HyVanila/releases/download/$TAG_NAME/HyVanila-macOS-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          name: ${{ steps.version.outputs.release_name }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          body: |
            ## HyVanila ${{ steps.version.outputs.release_name }}
            
            ${{ steps.version.outputs.is_prerelease == 'true' && 'âš ï¸ This is a pre-release nightly build for testing.' || 'ðŸŽ‰ Stable release' }}
            
            ### Installation
            - **Windows**: Download \`HyVanila-Portable.exe\`
            - **macOS**: Download \`HyVanila-macOS-arm64.dmg\`
            - **Linux**: Download \`HyVanila.flatpak\` (recommended) or \`HyVanila-x86_64.AppImage\`
            
            ### Changes
            See commit history for details.
